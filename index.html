<html>
<head>
    <title>Schedule to Calendar</title>
    <!-- import gapi -->
    <script src="api.js"></script>
    <!-- import jquery -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.1.1/jquery.min.js"></script>
</head>

<body>
    <div id="main">
        <!-- login google button -->
        <div id="login">
                <button id="authorize-button">Authorize</button>
        </div>

        <!-- content -->
        <div id="content"></div>
    </div>
    <script>
        const API_KEY = 'AIzaSyC5NONjaajXyqqDuByQEiyeeRo_NanhAHo';
        const CLIENT_ID = '796952607356-gsj82osa6j1r7j88vca6ru08q9r5ncda.apps.googleusercontent.com';
        const DISCOVERY_DOCS = ['https://www.googleapis.com/discovery/v1/apis/calendar/v3/rest'];
        const SCOPES = "https://www.googleapis.com/auth/calendar.readonly";


        function handleClientLoad() { //Esta funcion se encarga de cargar el cliente
            alert("handleClientLoad");
            gapi.load('client:auth2', initClient);
        }

        function initClient() { //Esta funcion se encarga de inicializar el cliente
            gapi.client.init({ //Inicializa el cliente
                apiKey: API_KEY,
                clientId: CLIENT_ID,
                discoveryDocs: DISCOVERY_DOCS,
                scope: SCOPES
            }).then(function () { //Cuando se inicializa el cliente se ejecuta la funcion
                // esta funcion se encarga de actualizar el estado de la autenticacion
                gapi.auth2.getAuthInstance().isSignedIn.listen(updateSigninStatus);
                // se actualiza el estado de la autenticacion
                updateSigninStatus(gapi.auth2.getAuthInstance().isSignedIn.get());
                authorizeButton.onclick = handleAuthClick;
            });
        }

        function updateSigninStatus(isSignedIn) { //Esta funcion se encarga de actualizar el estado de la autenticacion
            if (isSignedIn) { //Si esta autenticado
                authorizeButton.style.display = 'none'; //Se oculta el boton de autenticacion
                //Se llama a la funcion que se encarga de obtener los eventos
                getEvents();
            } else { //Si no esta autenticado
                authorizeButton.style.display = 'block'; //Se muestra el boton de autenticacion
            }
        }


        function handleAuthClick(event) { //Esta funcion se encarga de manejar el evento de autenticacion
            gapi.auth2.getAuthInstance().signIn(); //Se autentica
        }

        function getEvents() { //Esta funcion se encarga de obtener los eventos
            //Se obtienen los eventos
            gapi.client.calendar.events.list({
                'calendarId': 'primary',
                'timeMin': (new Date()).toISOString(),
                'showDeleted': false,
                'singleEvents': true,
                'maxResults': 10,
                'orderBy': 'startTime'
            }).then(function (response) { //Cuando se obtienen los eventos se ejecuta la funcion
                //Se obtienen los eventos
                var events = response.result.items;
                //Se llama a la funcion que se encarga de mostrar los eventos
                showEvents(events);
            });
        }

        function showEvents(events) { //Esta funcion se encarga de mostrar los eventos
            //Se recorren los eventos
            for (i = 0; i < events.length; i++) {
                //Se obtiene el evento
                var event = events[i];
                //Se obtiene la fecha de inicio del evento
                var start = event.start.dateTime || event.start.date;
                //Se obtiene la fecha de fin del evento
                var end = event.end.dateTime || event.end.date;
                //Se muestra el evento
                appendPre(event.summary + ' (' + start + ' - ' + end + ')')
            }
        }

        function appendPre(message) { //Esta funcion se encarga de mostrar el evento
            //Se crea un elemento pre
            var pre = document.getElementById('content');
            //Se crea un elemento text
            var textContent = document.createTextNode(message + '\n');
            //Se agrega el elemento text al elemento pre
            pre.appendChild(textContent);
        }

        
        const authorizeButton = document.getElementById('authorize-button');

        //Se llama a la funcion que se encarga de cargar el cliente
        handleClientLoad();

        authorizeButton.addEventListener('click', handleAuthClick);
    
        
    </script>
</body>

</html>